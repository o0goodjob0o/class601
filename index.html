<!DOCTYPE html>
<html lang="zh-TW">
<!--
    æ™®æ™®é¢¨ç­ç´šæ¦®è­½é»æ•¸ç³»çµ± V4.1
    
    ç³»çµ±æ¨¡å¼èªªæ˜ï¼š
    1. å®¶é•·æ¨¡å¼ï¼ˆé è¨­ï¼‰ï¼šç›´æ¥é–‹å•ŸHTMLæ–‡ä»¶ï¼Œåƒ…èƒ½æŸ¥çœ‹å­¸ç”Ÿé»æ•¸ï¼Œç„¡æ³•ä¿®æ”¹
       - ç‰¹è‰²ï¼šé ‚éƒ¨ç¶ è‰²æ©«å¹…ã€ç¦ç”¨æ‰€æœ‰äº’å‹•åŠŸèƒ½ã€éš±è—ç®¡ç†æŒ‰éˆ•
       - é©åˆï¼šåˆ†äº«çµ¦å®¶é•·æŸ¥çœ‹å­©å­çš„é»æ•¸ç‹€æ³
    
    2. æ•™å¸«æ¨¡å¼ï¼šç¶²å€åŠ ä¸Š ?mode=teacher åƒæ•¸
       - ç‰¹è‰²ï¼šå®Œæ•´ç®¡ç†åŠŸèƒ½ã€å¯åŠ æ‰£åˆ†ã€ç®¡ç†å­¸ç”Ÿã€åŒ¯å‡ºæˆç¸¾ç­‰
       - é©åˆï¼šæ•™å¸«é€²è¡Œç­ç´šç®¡ç†
       - ç¯„ä¾‹ï¼šfile:///path/to/file.html?mode=teacher
    
    ä½¿ç”¨æ–¹å¼ï¼š
    - æ•™å¸«ï¼šåœ¨ç¶²å€å¾ŒåŠ ä¸Š ?mode=teacher é€²å…¥ç®¡ç†æ¨¡å¼
    - å®¶é•·ï¼šä½¿ç”¨æ•™å¸«æ¨¡å¼ä¸‹ç”Ÿæˆçš„QRç¢¼æˆ–é€£çµï¼Œæœƒè‡ªå‹•è¿”å›å®¶é•·æª¢è¦–æ¨¡å¼
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™®æ™®é¢¨ç­ç´šæ¦®è­½é»æ•¸ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* è‡ªå®šç¾© Pop Art é¢¨æ ¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fef3c7; /* æº«æš–çš„é»ƒè‰²èƒŒæ™¯ */
        }
        .font-anton {
            font-family: 'Anton', sans-serif;
            letter-spacing: 0.05em;
        }
        .pop-shadow {
            box-shadow: 8px 8px 0px black;
        }
        .pop-shadow-sm {
            box-shadow: 4px 4px 0px black;
        }
        .pop-button {
            transition: all 0.15s ease-out;
        }
        .pop-button:hover {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px black;
        }
        .pop-button:active {
            transform: translate(8px, 8px);
            box-shadow: none;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .student-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .student-card:hover {
            transform: scale(1.05) rotate(-1deg);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.8);
        }
        /* é»æ•¸å¢æ¸›å‹•ç•« */
        .point-change-up {
            animation: point-up 0.8s ease-out forwards;
        }
        .point-change-down {
            animation: point-down 0.8s ease-out forwards;
        }
        @keyframes point-up {
            0% { transform: translateY(0) scale(1); opacity: 1; color: #16a34a; } /* green-600 */
            100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
        }
        @keyframes point-down {
            0% { transform: translateY(0) scale(1); opacity: 1; color: #dc2626; } /* red-600 */
            100% { transform: translateY(40px) scale(1.5); opacity: 0; }
        }
        /* åˆ†é æ¨£å¼ */
        .tab-button {
            transition: all 0.2s ease-out;
        }
        .tab-button:not(.active-tab):hover {
            transform: translateY(-2px);
        }
        .active-tab {
            background-color: #facc15 !important; /* yellow-400 */
            transform: translateY(-2px);
            box-shadow: 0 4px 0 black;
        }
        .group-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .group-card:hover {
            transform: scale(1.02) rotate(-0.5deg);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.8);
        }
        /* éŒ¯èª¤é–ƒçˆå‹•ç•« */
        .error-flash {
            animation: error-flash 0.5s ease-in-out 6;
        }
        @keyframes error-flash {
            0%, 100% { background-color: transparent; color: inherit; }
            50% { background-color: #fca5a5; color: #dc2626; }
        }
        /* å®¶é•·æ¨¡å¼æ¨£å¼ */
        .parent-mode .student-card,
        .parent-mode .group-card {
            cursor: default !important;
            pointer-events: none;
        }
        .parent-mode .student-card:hover,
        .parent-mode .group-card:hover {
            transform: none !important;
            box-shadow: 8px 8px 0px black !important;
        }
        .parent-mode-banner {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-bottom: 4px solid black;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- é ‚éƒ¨æ¨™é¡Œå’Œæ§åˆ¶æŒ‰éˆ• -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-baseline gap-x-3 md:gap-x-4">
                <h1 id="class-name-title" class="font-anton text-4xl md:text-6xl text-black drop-shadow-[4px_4px_0px_#facc15]">Classroom Points!</h1>
                <span class="font-normal text-gray-600 text-sm md:text-base whitespace-nowrap">(Made by é˜¿å‰›è€å¸«)</span>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="sort-btn" class="text-4xl hover:scale-110 transition-transform" title="ç›®å‰ï¼šæŒ‰å§“åæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºæŒ‰åˆ†æ•¸æ’åº">â˜…</button>
                <button id="parent-link-btn" class="text-4xl hover:scale-110 transition-transform" title="ç”Ÿæˆå®¶é•·æª¢è¦–é€£çµ">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</button>
                <button id="teacher-panel-btn" class="text-4xl hover:scale-110 transition-transform">ğŸ§‘â€ğŸ«</button>
                <button id="help-btn" class="text-4xl hover:scale-110 transition-transform">â“</button>
            </div>
        </header>

        <!-- æ•™å¸«ç®¡ç†é¢æ¿ (é è¨­éš±è—) -->
        <div id="control-panel" class="bg-blue-400 border-4 border-black p-4 rounded-lg pop-shadow mb-8 flex-wrap gap-4 justify-center hidden">
            <button id="manage-student-btn" class="pop-button pop-shadow-sm bg-green-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ç®¡ç†å­¸ç”Ÿ</button>
            <button id="manage-avatars-btn" class="pop-button pop-shadow-sm bg-cyan-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ä¸Šå‚³é ­åƒ</button>
            <button id="manage-behaviors-btn" class="pop-button pop-shadow-sm bg-yellow-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ç®¡ç†è¡Œç‚º</button>
            <button id="export-grades-btn" class="pop-button pop-shadow-sm bg-purple-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold text-lg">åŒ¯å‡ºæˆç¸¾</button>
            <button id="reset-points-btn" class="pop-button pop-shadow-sm bg-red-500 border-2 border-black rounded-md px-6 py-2 font-bold text-lg text-white">é‡è¨­é»æ•¸</button>
        </div>

        <!-- åˆ†é å°èˆª -->
        <div id="tabs-container" class="mb-8 hidden">
            <div class="flex border-b-4 border-black">
                <button id="students-tab" class="tab-button active-tab px-6 py-3 font-bold text-lg bg-yellow-400 border-4 border-black border-b-0 rounded-t-lg mr-2">å­¸ç”Ÿ</button>
                <button id="groups-tab" class="tab-button px-6 py-3 font-bold text-lg bg-gray-300 border-4 border-black border-b-0 rounded-t-lg hover:bg-gray-200">åˆ†çµ„</button>
            </div>
        </div>

        <!-- å­¸ç”Ÿæª¢è¦– -->
        <div id="students-view" class="tab-content">
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- å­¸ç”Ÿå¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆ†çµ„æª¢è¦– -->
        <div id="groups-view" class="tab-content hidden">
            <div id="groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åˆ†çµ„å¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆå§‹æç¤º/è¼‰å…¥ç•«é¢ -->
        <div id="initial-prompt" class="text-center py-20">
            <p id="loading-text" class="text-2xl font-bold">æ­£åœ¨å¾ Google Sheet è¼‰å…¥è³‡æ–™...</p>
            <div id="spinner" class="animate-spin rounded-full h-12 w-12 border-b-4 border-black mx-auto mt-4"></div>
            <p id="setup-prompt" class="hidden mt-4 text-lg">çœ‹èµ·ä¾†æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼è«‹åœ¨ç¨‹å¼ç¢¼ä¸­æ›´æ–° gasUrl è®Šæ•¸ç‚ºæ‚¨çš„ Google Apps Script ç¶²å€ã€‚</p>
        </div>

    </div>

    <!-- æ‰€æœ‰å½ˆå‡ºè¦–çª— (Modals) -->


    <!-- è¨­å®š Modal -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-yellow-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 class="font-anton text-3xl mb-4">è¨­å®š GAS ç¶²å€</h2>
            <p class="mb-4">è«‹è²¼ä¸Šæ‚¨å¾ Google Apps Script ç™¼å¸ƒå¾Œå–å¾—çš„ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€‚</p>
            <input type="url" id="gas-url-input" class="w-full p-2 border-2 border-black rounded-md mb-4" placeholder="https://script.google.com/macros/s/...">
            <div class="flex justify-end space-x-4">
                <button id="cancel-settings-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">å–æ¶ˆ</button>
                <button id="save-settings-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- èªªæ˜ Modal -->
    <div id="help-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-3xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 90vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">è¨­å®šèªªæ˜</h2>
            <div class="prose max-w-none overflow-y-auto flex-grow pr-2">
                <h4>æ­¥é©Ÿ 1ï¼šå»ºç«‹ Google è©¦ç®—è¡¨</h4>
                <ol>
                    <li>å‰å¾€ <a href="https://sheets.new" target="_blank" class="text-blue-600 font-bold">sheets.new</a> å»ºç«‹ä¸€ä»½æ–°çš„ Google è©¦ç®—è¡¨ã€‚</li>
                    <li>ç‚ºæ‚¨çš„è©¦ç®—è¡¨å‘½åï¼Œä¾‹å¦‚ã€Œç­ç´šé»æ•¸ç³»çµ±ã€ã€‚</li>
                    <li><strong>âœ¨ æ–°åŠŸèƒ½ï¼š</strong>ç³»çµ±æœƒè‡ªå‹•å»ºç«‹æ‰€éœ€çš„å·¥ä½œè¡¨ï¼ˆStudents, Behaviors, Log, Configï¼‰åŠé è¨­è³‡æ–™ï¼ŒåŒ…å«å…©ä½ç¯„ä¾‹å­¸ç”Ÿã€‚</li>
                    <li><strong>å¯é¸ï¼š</strong>å¦‚æœè¦ä¿®æ”¹ç­ç´šåç¨±ï¼Œå¯åœ¨ <code>Config</code> å·¥ä½œè¡¨çš„ A1 æ ¼è¼¸å…¥æ‚¨çš„ç­ç´šåç¨±ã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 2ï¼šå»ºç«‹ Google Apps Script (GAS)</h4>
                <ol>
                    <li>åœ¨è©¦ç®—è¡¨é¸å–®ä¸­ï¼Œé»æ“Šã€Œæ“´å……åŠŸèƒ½ã€ > ã€ŒApps Scriptã€ã€‚</li>
                    <li>åˆªé™¤æŒ‡ä»¤ç¢¼ç·¨è¼¯å™¨ä¸­æ‰€æœ‰é è¨­çš„ç¨‹å¼ç¢¼ã€‚</li>
                    <li>å°‡ä¸‹æ–¹çš„æ‰€æœ‰ç¨‹å¼ç¢¼è¤‡è£½ä¸¦è²¼åˆ°ç·¨è¼¯å™¨ä¸­ã€‚</li>
                    <li>é»æ“Šä¸Šæ–¹çš„ã€Œå„²å­˜å°ˆæ¡ˆã€åœ–ç¤º (ğŸ’¾)ã€‚</li>
                </ol>
                
                <div class="relative bg-gray-800 text-white p-4 rounded-md my-4">
                    <button id="copy-gas-code-btn" class="absolute top-2 right-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-sm">è¤‡è£½</button>
                    <pre><code id="gas-code-block" class="text-sm whitespace-pre-wrap">
function doPost(e) {
  try {
    const postData = JSON.parse(e.postData.contents);
    const action = postData.action;
    const payload = postData.payload;
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    switch (action) {
      case "loadData":
        return handleLoadData(ss);
      case "addMultipleStudents":
        return handleAddMultipleStudents(ss, payload);
      case "deleteStudent":
        return handleDeleteStudent(ss, payload);
      case "updatePoints":
        return handleUpdatePoints(ss, payload);
      case "getHistory":
        return handleGetHistory(ss, payload);
      case "resetAllPoints":
        return handleResetAllPoints(ss);
      case "manageBehaviors":
        return handleManageBehaviors(ss, payload);
      case "updateMultiplePoints":
        return handleUpdateMultiplePoints(ss, payload);
      case "updateStudentAvatar":
        return handleUpdateStudentAvatar(ss, payload);
      default:
        return createJsonResponse({ status: "error", message: "Unknown action: " + action });
    }
  } catch (err) {
    return createJsonResponse({ status: "error", message: err.message, stack: err.stack });
  }
}

function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleLoadData(ss) {
  // è‡ªå‹•å»ºç«‹æ‰€éœ€çš„å·¥ä½œè¡¨
  let studentSheet = ss.getSheetByName("Students");
  let behaviorSheet = ss.getSheetByName("Behaviors");
  let logSheet = ss.getSheetByName("Log");
  let configSheet = ss.getSheetByName("Config");

  // å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œå‰‡å»ºç«‹å®ƒå€‘
  if (!studentSheet) {
    studentSheet = ss.insertSheet("Students");
  }
  if (!behaviorSheet) {
    behaviorSheet = ss.insertSheet("Behaviors");
  }
  if (!logSheet) {
    logSheet = ss.insertSheet("Log");
  }
  if (!configSheet) {
    configSheet = ss.insertSheet("Config");
  }

  // åˆå§‹åŒ– Config å·¥ä½œè¡¨
  if (configSheet.getLastRow() === 0) {
    configSheet.getRange("A1").setValue("æˆ‘çš„ç­ç´š");
  }

  // åˆå§‹åŒ– Students å·¥ä½œè¡¨
  if (studentSheet.getLastRow() === 0) {
    // è¨­å®šæ¨™é¡Œåˆ—
    studentSheet.getRange("A1:E1").setValues([["id", "name", "points", "avatar", "group"]]);
    
    // ç”Ÿæˆç¯„ä¾‹å­¸ç”Ÿçš„é è¨­é ­åƒ
    const generateAvatar = (seed) => {
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
      const bgColor = colors[Math.abs(seed.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % colors.length];
      return `data:image/svg+xml,${encodeURIComponent(`<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="20" fill="${bgColor}" /><circle cx="35" cy="40" r="8" fill="white"/><circle cx="35" cy="40" r="4" fill="black"/><circle cx="65" cy="40" r="8" fill="white"/><circle cx="65" cy="40" r="4" fill="black"/><path d="M35 70 Q 50 85, 65 70" stroke="white" stroke-width="5" fill="none"/></svg>`)}`;
    };
    
    // æ–°å¢å…©å€‹ç¯„ä¾‹å­¸ç”Ÿ
    const sampleStudents = [
      [Utilities.getUuid(), "ç‹å°æ˜", 0, generateAvatar("ç‹å°æ˜"), "ç¬¬ä¸€çµ„"],
      [Utilities.getUuid(), "é™³å°è¯", 0, generateAvatar("é™³å°è¯"), "ç¬¬äºŒçµ„"]
    ];
    studentSheet.getRange(2, 1, sampleStudents.length, 5).setValues(sampleStudents);
  }

  // åˆå§‹åŒ– Behaviors å·¥ä½œè¡¨
  if (behaviorSheet.getLastRow() === 0) {
    const defaultBehaviors = [
      ["name", "points", "type"],
      ["ç©æ¥µåƒèˆ‡", 1, "positive"], 
      ["å¹«åŠ©åŒå­¸", 1, "positive"], 
      ["æº–æ™‚äº¤ä½œæ¥­", 2, "positive"],
      ["åœ˜éšŠåˆä½œ", 1, "positive"], 
      ["å‰µæ„è¡¨ç¾", 2, "positive"],
      ["ä¸Šèª²åˆ†å¿ƒ", -1, "negative"], 
      ["æœªäº¤ä½œæ¥­", -2, "negative"],
      ["å¹²æ“¾ç§©åº", -1, "negative"],
      ["é²åˆ°æ—©é€€", -1, "negative"]
    ];
    behaviorSheet.getRange(1, 1, defaultBehaviors.length, 3).setValues(defaultBehaviors);
  }

  // åˆå§‹åŒ– Log å·¥ä½œè¡¨
  if (logSheet.getLastRow() === 0) {
    logSheet.getRange("A1:D1").setValues([["timestamp", "studentId", "behaviorName", "points"]]);
  }

  // è®€å–è³‡æ–™
  const students = studentSheet.getLastRow() > 1 ? studentSheet.getRange(2, 1, studentSheet.getLastRow() - 1, 5).getValues() : [];
  const behaviors = behaviorSheet.getLastRow() > 1 ? behaviorSheet.getRange(2, 1, behaviorSheet.getLastRow() - 1, 3).getValues() : [];
  const className = configSheet.getRange("A1").getValue() || "æˆ‘çš„ç­ç´š";

  const data = {
    className: className,
    students: students.map(row => ({ id: row[0], name: row[1], points: Number(row[2]) || 0, avatar: row[3], group: row[4] || '' })),
    behaviors: behaviors.map(row => ({ name: row[0], points: Number(row[1]) || 0, type: row[2] }))
  };
  return createJsonResponse({ status: "success", data: data });
}

function handleAddMultipleStudents(ss, payload) {
  let studentSheet = ss.getSheetByName("Students");
  if (!studentSheet) {
    studentSheet = ss.insertSheet("Students");
  }
  if (studentSheet.getLastRow() === 0) {
    studentSheet.getRange("A1:E1").setValues([["id", "name", "points", "avatar", "group"]]);
  }
  
  const newStudentsPayload = payload.students;
  const newStudentsForSheet = [];
  const newStudentsForState = [];

  newStudentsPayload.forEach(student => {
    const newId = Utilities.getUuid();
    const newStudent = { id: newId, name: student.name, points: 0, avatar: student.avatar, group: student.group || '' };
    newStudentsForSheet.push([newStudent.id, newStudent.name, newStudent.points, newStudent.avatar, newStudent.group]);
    newStudentsForState.push(newStudent);
  });

  if (newStudentsForSheet.length > 0) {
    studentSheet.getRange(studentSheet.getLastRow() + 1, 1, newStudentsForSheet.length, 5).setValues(newStudentsForSheet);
  }
  
  return createJsonResponse({ status: "success", data: newStudentsForState });
}

function handleDeleteStudent(ss, payload) {
  const { studentId } = payload;
  const studentSheet = ss.getSheetByName("Students");
  const studentData = studentSheet.getDataRange().getValues();
  // å¾å¾Œå¾€å‰æ‰¾ï¼Œé¿å…åˆªé™¤æ™‚å½±éŸ¿å¾ŒçºŒåˆ—çš„ç´¢å¼•
  for (let i = studentData.length - 1; i >= 1; i--) {
    if (studentData[i][0] === studentId) {
      studentSheet.deleteRow(i + 1);
      return createJsonResponse({ status: "success", data: { deletedStudentId: studentId } });
    }
  }
  return createJsonResponse({ status: "error", message: "Student not found to delete" });
}

function handleUpdatePoints(ss, payload) {
  const { studentId, behaviorName, points } = payload;
  let studentSheet = ss.getSheetByName("Students");
  let logSheet = ss.getSheetByName("Log");
  
  if (!studentSheet) {
    studentSheet = ss.insertSheet("Students");
  }
  if (!logSheet) {
    logSheet = ss.insertSheet("Log");
  }

  if (logSheet.getLastRow() === 0) {
    logSheet.getRange("A1:D1").setValues([["timestamp", "studentId", "behaviorName", "points"]]);
  }
  logSheet.appendRow([new Date(), studentId, behaviorName, points]);

  const studentData = studentSheet.getDataRange().getValues();
  for (let i = 1; i < studentData.length; i++) {
    if (studentData[i][0] === studentId) {
      const currentPoints = Number(studentData[i][2]) || 0;
      const newPoints = currentPoints + Number(points);
      studentSheet.getRange(i + 1, 3).setValue(newPoints);
      return createJsonResponse({ status: "success", data: { studentId: studentId, newPoints: newPoints } });
    }
  }
  return createJsonResponse({ status: "error", message: "Student not found" });
}

function handleGetHistory(ss, payload) {
    let logSheet = ss.getSheetByName("Log");
    if (!logSheet) {
        logSheet = ss.insertSheet("Log");
        logSheet.getRange("A1:D1").setValues([["timestamp", "studentId", "behaviorName", "points"]]);
    }
    if (logSheet.getLastRow() < 2) {
        return createJsonResponse({ status: "success", data: [] });
    }
    const logData = logSheet.getRange(2, 1, logSheet.getLastRow() - 1, 4).getValues();
    const history = logData
        .filter(row => row[1] === payload.studentId)
        .map(row => ({
            timestamp: new Date(row[0]).toLocaleString('zh-TW'),
            behaviorName: row[2],
            points: row[3]
        }))
        .reverse();
    return createJsonResponse({ status: "success", data: history });
}

function handleResetAllPoints(ss) {
    let studentSheet = ss.getSheetByName("Students");
    let logSheet = ss.getSheetByName("Log");
    
    if (!studentSheet) {
        studentSheet = ss.insertSheet("Students");
    }
    if (!logSheet) {
        logSheet = ss.insertSheet("Log");
    }
    
    if (studentSheet.getLastRow() > 1) {
        studentSheet.getRange(2, 3, studentSheet.getLastRow() - 1, 1).setValue(0);
    }
    if (logSheet.getLastRow() === 0) {
      logSheet.getRange("A1:D1").setValues([["timestamp", "studentId", "behaviorName", "points"]]);
    }
    logSheet.appendRow([new Date(), "SYSTEM", "æ‰€æœ‰é»æ•¸å·²é‡è¨­", 0]);
    return createJsonResponse({ status: "success", data: { success: true } });
}

function handleManageBehaviors(ss, payload) {
    let behaviorSheet = ss.getSheetByName("Behaviors");
    if (!behaviorSheet) {
        behaviorSheet = ss.insertSheet("Behaviors");
        behaviorSheet.getRange("A1:C1").setValues([["name", "points", "type"]]);
    }
    if (behaviorSheet.getLastRow() > 1) {
        behaviorSheet.getRange(2, 1, behaviorSheet.getLastRow() - 1, 3).clearContent();
    }
    if (payload.behaviors.length > 0) {
        const newBehaviorsData = payload.behaviors.map(b => [b.name, b.points, b.type]);
        behaviorSheet.getRange(2, 1, newBehaviorsData.length, 3).setValues(newBehaviorsData);
    }
    return createJsonResponse({ status: "success", data: { success: true } });
}

function handleUpdateMultiplePoints(ss, payload) {
    const { updates } = payload; // [{ studentId, behaviorName, points }, ...]
    let studentSheet = ss.getSheetByName("Students");
    let logSheet = ss.getSheetByName("Log");
    
    if (!studentSheet) {
        studentSheet = ss.insertSheet("Students");
    }
    if (!logSheet) {
        logSheet = ss.insertSheet("Log");
    }
    
    if (logSheet.getLastRow() === 0) {
        logSheet.getRange("A1:D1").setValues([["timestamp", "studentId", "behaviorName", "points"]]);
    }
    
    // æ‰¹é‡è¨˜éŒ„æ—¥èªŒ
    const logData = updates.map(update => [new Date(), update.studentId, update.behaviorName, update.points]);
    if (logData.length > 0) {
        logSheet.getRange(logSheet.getLastRow() + 1, 1, logData.length, 4).setValues(logData);
    }
    
    // æ‰¹é‡æ›´æ–°å­¸ç”Ÿåˆ†æ•¸
    const studentData = studentSheet.getDataRange().getValues();
    const updatedStudents = [];
    
    updates.forEach(update => {
        for (let i = 1; i < studentData.length; i++) {
            if (studentData[i][0] === update.studentId) {
                const currentPoints = Number(studentData[i][2]) || 0;
                const newPoints = currentPoints + Number(update.points);
                studentData[i][2] = newPoints;
                updatedStudents.push({ studentId: update.studentId, newPoints: newPoints });
                break;
            }
        }
    });
    
    // æ›´æ–°è©¦ç®—è¡¨
    studentSheet.getDataRange().setValues(studentData);
    
    return createJsonResponse({ status: "success", data: { updatedStudents: updatedStudents } });
}

function handleUpdateStudentAvatar(ss, payload) {
    const { studentId, avatar } = payload;
    let studentSheet = ss.getSheetByName("Students");
    if (!studentSheet) {
        studentSheet = ss.insertSheet("Students");
        studentSheet.getRange("A1:E1").setValues([["id", "name", "points", "avatar", "group"]]);
    }
    const studentData = studentSheet.getDataRange().getValues();
    
    for (let i = 1; i < studentData.length; i++) {
        if (studentData[i][0] === studentId) {
            studentSheet.getRange(i + 1, 4).setValue(avatar); // ç¬¬4æ¬„æ˜¯avataræ¬„ä½
            return createJsonResponse({ status: "success", data: { success: true } });
        }
    }
    
    return createJsonResponse({ status: "error", message: "Student not found for avatar update" });
}
                    </code></pre>
                </div>

                <h4>æ­¥é©Ÿ 3ï¼šç™¼å¸ƒç¶²é æ‡‰ç”¨ç¨‹å¼</h4>
                <ol>
                    <li>åœ¨ Apps Script ç·¨è¼¯å™¨å³ä¸Šè§’ï¼Œé»æ“Šã€Œéƒ¨ç½²ã€ > ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€ã€‚</li>
                    <li>åœ¨ã€Œé¸å–é¡å‹ã€æ—ï¼Œé»æ“Šé½’è¼ªåœ–ç¤º âš™ï¸ï¼Œé¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li>åœ¨ã€Œèªªæ˜ã€æ¬„ä½è¼¸å…¥ã€Œç­ç´šé»æ•¸ç³»çµ± v4.2 - è‡ªå‹•å»ºè¡¨+é ­åƒä¸Šå‚³ã€ã€‚</li>
                    <li>åœ¨ã€ŒåŸ·è¡Œèº«åˆ†ã€é¸æ“‡ã€Œæˆ‘ã€ã€‚</li>
                    <li>åœ¨ã€Œèª°å¯ä»¥å­˜å–ã€é¸æ“‡ã€Œä»»ä½•äººã€ã€‚<strong>(é€™æ˜¯ç‚ºäº†è®“æ‚¨çš„å‰ç«¯ç¶²é èƒ½å‘¼å«å®ƒï¼Œè³‡æ–™æœ¬èº«ä»æ˜¯å®‰å…¨çš„)</strong></li>
                    <li>é»æ“Šã€Œéƒ¨ç½²ã€ã€‚</li>
                    <li>åœ¨å½ˆå‡ºçš„è¦–çª—ä¸­ï¼Œé»æ“Šã€Œæˆæ¬Šå­˜å–ã€ï¼Œä¸¦åŒæ„ Google çš„æ¬Šé™è¦æ±‚ã€‚</li>
                    <li>æœ€å¾Œï¼Œæ‚¨æœƒå¾—åˆ°ä¸€å€‹ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€çš„ç¶²å€ã€‚<strong>è¤‡è£½é€™å€‹ç¶²å€</strong>ã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 4ï¼šè¨­å®šæœ¬ç¶²é </h4>
                <ol>
                    <li>åœ¨ç¨‹å¼ç¢¼ä¸­æ‰¾åˆ° <code>gasUrl: 'demo'</code> é€™ä¸€è¡Œã€‚</li>
                    <li>å°‡ <code>'demo'</code> æ›´æ›ç‚ºæ‚¨å‰›æ‰è¤‡è£½çš„ GAS ç¶²å€ã€‚</li>
                    <li>å„²å­˜æª”æ¡ˆä¸¦é‡æ–°æ•´ç†ç¶²é ã€‚</li>
                    <li>å®Œæˆï¼æ‚¨å°±å¯ä»¥é–‹å§‹ä½¿ç”¨äº†ï¼</li>
                </ol>
            </div>
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-help-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">æˆ‘æ‡‚äº†ï¼</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å­¸ç”Ÿ Modal -->
    <div id="manage-student-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-green-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">ç®¡ç†å­¸ç”Ÿ</h2>
            
            <!-- æ–°å¢å­¸ç”Ÿå€å¡Š -->
            <div class="mb-4 pb-4 border-b-2 border-black">
                <h3 class="font-bold text-xl mb-2">æ–°å¢å­¸ç”Ÿ</h3>
                <p class="mb-2 text-sm">è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼Œæ¯ä½å­¸ç”Ÿä½”ä¸€è¡Œã€‚å¯ä»¥åªè¼¸å…¥å§“åæˆ–ã€Œå§“åï¼Œåˆ†çµ„ã€çš„æ ¼å¼ã€‚</p>
                <textarea id="student-name-input" class="w-full h-24 p-2 border-2 border-black rounded-md mb-2" placeholder="ç‹å°æ˜&#10;é™³å¤§è¯,ç¬¬ä¸€çµ„&#10;æ—ç¾éº—	ç¬¬äºŒçµ„"></textarea>
                <button id="confirm-add-student-btn" class="w-full pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">ç¢ºèªæ–°å¢</button>
            </div>

            <!-- åˆªé™¤å­¸ç”Ÿå€å¡Š -->
            <div class="flex-grow overflow-y-auto">
                 <h3 class="font-bold text-xl mb-2">åˆªé™¤å­¸ç”Ÿ</h3>
                 <div id="delete-student-list" class="space-y-2 pr-2">
                    <!-- å­¸ç”Ÿåˆ—è¡¨å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                 </div>
            </div>

            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-manage-student-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å‡ºæˆç¸¾ Modal -->
    <div id="export-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-teal-300 w-full max-w-sm p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 class="font-anton text-3xl mb-4">åŒ¯å‡ºæˆç¸¾</h2>
            <p class="mb-6">è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼š</p>
            <div class="flex flex-col space-y-4">
                <button id="export-original-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold">æŒ‰åˆ†çµ„å§“åé †åºåŒ¯å‡º</button>
                <button id="export-sorted-btn" class="pop-button pop-shadow-sm bg-green-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold">æŒ‰å¾—åˆ†é«˜ä½åŒ¯å‡º</button>
            </div>
            <div class="mt-6 text-right">
                <button id="cancel-export-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åŠ æ¸›åˆ† Modal -->
    <div id="points-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-purple-300 w-full max-w-lg p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 id="points-modal-title" class="font-anton text-3xl mb-4 text-center">çµ¦äºˆé»æ•¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- åŠ åˆ†é …ç›® -->
                <div>
                    <h3 class="font-bold text-xl text-green-700 mb-2">åŠ åˆ†é …ç›®</h3>
                    <div id="positive-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
                <!-- æ‰£åˆ†é …ç›® -->
                <div>
                    <h3 class="font-bold text-xl text-red-700 mb-2">å¾…æ”¹é€²é …ç›®</h3>
                    <div id="negative-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="view-history-btn" class="pop-button pop-shadow-sm bg-yellow-400 border-2 border-black rounded-md px-4 py-2 font-bold">æŸ¥çœ‹ç´€éŒ„</button>
                 <button id="close-points-modal-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-4 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ Modal -->
    <div id="history-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-pink-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 70vh;">
            <h2 id="history-modal-title" class="font-anton text-3xl mb-4 flex-shrink-0">æ­·å²ç´€éŒ„</h2>
            <div id="history-list" class="flex-grow overflow-y-auto bg-white/50 p-2 rounded-md border-2 border-black">
                <!-- ç´€éŒ„å°‡æ’å…¥æ­¤è™• -->
            </div>
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-history-modal-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†è¡Œç‚º Modal -->
    <div id="manage-behaviors-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-orange-300 w-full max-w-2xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">ç®¡ç†è¡Œç‚ºé …ç›®</h2>
            <div class="flex-grow overflow-y-auto space-y-4" id="behavior-list-editor">
                <!-- è¡Œç‚ºç·¨è¼¯å™¨å°‡æ’å…¥æ­¤è™• -->
            </div>
            <div class="mt-4 pt-4 border-t-2 border-black flex-shrink-0 flex justify-between">
                <button id="add-new-behavior-btn" class="pop-button pop-shadow-sm bg-green-400 border-2 border-black rounded-md px-4 py-2 font-bold">æ–°å¢ä¸€é …</button>
                <div>
                    <button id="cancel-behaviors-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">å–æ¶ˆ</button>
                    <button id="save-behaviors-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å®¶é•·æ¨¡å¼é€£çµ Modal -->
    <div id="parent-link-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-green-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 class="font-anton text-3xl mb-4 text-center">å®¶é•·æª¢è¦–é€£çµ</h2>
            <div class="text-center mb-4">
                <p class="mb-2 font-bold">æƒæQRç¢¼æˆ–è¤‡è£½é€£çµåˆ†äº«çµ¦å®¶é•·ï¼š</p>
                <div id="qr-code-container" class="flex justify-center mb-4">
                    <canvas id="qr-canvas" class="border-2 border-black"></canvas>
                </div>
                <div class="bg-white border-2 border-black rounded-md p-3 mb-4">
                    <input type="text" id="parent-url-display" class="w-full text-sm text-center bg-transparent border-none outline-none" readonly>
                </div>
                <button id="copy-parent-url-btn" class="w-full pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold mb-2">ğŸ“‹ è¤‡è£½é€£çµ</button>
                <p class="text-xs text-gray-600">å®¶é•·ä½¿ç”¨æ­¤é€£çµåªèƒ½æª¢è¦–ï¼Œç„¡æ³•ä¿®æ”¹é»æ•¸</p>
            </div>
            <div class="text-right">
                <button id="close-parent-link-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- é ­åƒç®¡ç† Modal -->
    <div id="manage-avatars-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-cyan-300 w-full max-w-4xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">å­¸ç”Ÿé ­åƒç®¡ç†</h2>
            <p class="text-sm mb-4 text-gray-700">é»æ“Šå­¸ç”Ÿé ­åƒå³å¯ä¸Šå‚³æ–°åœ–ç‰‡ï¼Œåœ–ç‰‡å°‡è‡ªå‹•å£“ç¸®ç‚ºå¯¬åº¦200px</p>
            
            <!-- å­¸ç”Ÿé ­åƒç¶²æ ¼ -->
            <div class="flex-grow overflow-y-auto">
                <div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- å­¸ç”Ÿé ­åƒå¡ç‰‡å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
            </div>
            
            <!-- éš±è—çš„æ–‡ä»¶ä¸Šå‚³è¼¸å…¥ -->
            <input type="file" id="avatar-file-input" accept="image/*" class="hidden">
            
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-avatars-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- å…ƒç´ é¸æ“‡ ---
        const getEl = (id) => document.getElementById(id);
        const app = {
            modals: {
                settings: getEl('settings-modal'),
                help: getEl('help-modal'),
                manageStudent: getEl('manage-student-modal'),
                manageAvatars: getEl('manage-avatars-modal'),
                export: getEl('export-modal'),
                points: getEl('points-modal'),
                history: getEl('history-modal'),
                manageBehaviors: getEl('manage-behaviors-modal'),
                parentLink: getEl('parent-link-modal'),
            },
            buttons: {
                sort: getEl('sort-btn'),
                teacherPanel: getEl('teacher-panel-btn'),
                parentLink: getEl('parent-link-btn'),
                settings: getEl('settings-btn'),
                help: getEl('help-btn'),
                saveSettings: getEl('save-settings-btn'),
                cancelSettings: getEl('cancel-settings-btn'),
                closeHelp: getEl('close-help-btn'),
                copyGasCode: getEl('copy-gas-code-btn'),
                manageStudent: getEl('manage-student-btn'),
                closeManageStudent: getEl('close-manage-student-btn'),
                confirmAddStudent: getEl('confirm-add-student-btn'),
                manageAvatars: getEl('manage-avatars-btn'),
                closeAvatars: getEl('close-avatars-btn'),
                exportGrades: getEl('export-grades-btn'),
                exportOriginal: getEl('export-original-btn'),
                exportSorted: getEl('export-sorted-btn'),
                cancelExport: getEl('cancel-export-btn'),
                closePoints: getEl('close-points-modal-btn'),
                viewHistory: getEl('view-history-btn'),
                closeHistory: getEl('close-history-modal-btn'),
                resetPoints: getEl('reset-points-btn'),
                manageBehaviors: getEl('manage-behaviors-btn'),
                saveBehaviors: getEl('save-behaviors-btn'),
                cancelBehaviors: getEl('cancel-behaviors-btn'),
                addNewBehavior: getEl('add-new-behavior-btn'),
                copyParentUrl: getEl('copy-parent-url-btn'),
                closeParentLink: getEl('close-parent-link-btn'),
            },
            inputs: {
                gasUrl: getEl('gas-url-input'),
                studentName: getEl('student-name-input'),
                avatarFile: getEl('avatar-file-input'),
            },
            containers: {
                controlPanel: getEl('control-panel'),
                studentGrid: getEl('student-grid'),
                groupsGrid: getEl('groups-grid'),
                tabsContainer: getEl('tabs-container'),
                studentsView: getEl('students-view'),
                groupsView: getEl('groups-view'),
                studentsTab: getEl('students-tab'),
                groupsTab: getEl('groups-tab'),
                initialPrompt: getEl('initial-prompt'),
                loadingText: getEl('loading-text'),
                setupPrompt: getEl('setup-prompt'),
                spinner: getEl('spinner'),
                positiveBehaviors: getEl('positive-behaviors'),
                negativeBehaviors: getEl('negative-behaviors'),
                historyList: getEl('history-list'),
                behaviorListEditor: getEl('behavior-list-editor'),
                deleteStudentList: getEl('delete-student-list'),
                avatarGrid: getEl('avatar-grid'),
            },
            sounds: {
                positive: () => new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
                negative: () => new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, release: 0.3 } }).toDestination().triggerAttackRelease("A2", "8n"),
                click: () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2 }).toDestination().triggerAttackRelease("C2", "8n", Tone.now())
            },
            titles: {
                className: getEl('class-name-title'),
                pointsModal: getEl('points-modal-title'),
                historyModal: getEl('history-modal-title'),
            }
        };

        // --- æ¨¡å¼æª¢æ¸¬ï¼ˆé è¨­ç‚ºå®¶é•·æ¨¡å¼ï¼‰ ---
        const urlParams = new URLSearchParams(window.location.search);
        const isTeacherMode = urlParams.get('mode') === 'teacher';
        const isParentMode = !isTeacherMode; // é è¨­ç‚ºå®¶é•·æ¨¡å¼
        
        // å¦‚æœæ˜¯å®¶é•·æ¨¡å¼ï¼Œæ·»åŠ CSSé¡å’Œæ©«å¹…
        if (isParentMode) {
            document.body.classList.add('parent-mode');
            const banner = document.createElement('div');
            banner.className = 'parent-mode-banner';
            banner.textContent = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•·æª¢è¦–æ¨¡å¼ - åƒ…ä¾›æŸ¥çœ‹ï¼Œç„¡æ³•ä¿®æ”¹';
            document.body.insertBefore(banner, document.body.firstChild);
        }

        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            // è«‹åœ¨ä¸‹æ–¹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ï¼ˆéœ€è¦å…ˆéƒ¨ç½² GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ï¼‰
            // ä¾‹å¦‚ï¼šgasUrl: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
            gasUrl: 'https://script.google.com/macros/s/AKfycbySL3nqKqeHcA_sMTk6FWxu5MkSbj2PUQZNSOYjZBOuUxkIExc6yk5SGN5xdgRv-C1yeQ/exec', // è«‹æŠŠ 'demo' æ›´æ›ç‚ºæ‚¨çš„ GAS ç¶²å€
            students: [],
            behaviors: [],
            groups: {},
            isLoading: true,
            currentStudentId: null,
            currentGroupName: null,
            className: 'Classroom Points!',
            sortOrder: 'byName', // 'byName', 'byPoints', or 'byGroup'
            activeTab: 'students', // 'students' or 'groups'
            pendingOperations: new Map(), // è¿½è¹¤æœªåŒæ­¥çš„æ“ä½œ
            retryQueue: [], // é‡è©¦ä½‡åˆ—
            isParentMode: isParentMode, // å®¶é•·æ¨¡å¼ç‹€æ…‹
            isTeacherMode: isTeacherMode, // æ•™å¸«æ¨¡å¼ç‹€æ…‹
            
            // å¿«å–ç®¡ç†é…ç½®
            cacheKey: 'classpoints_cache',
            cacheTimestampKey: 'classpoints_cache_timestamp',
            cacheDuration: 5 * 60 * 1000, // 5åˆ†é˜å¿«å–æ™‚é–“
            
            // é ­åƒä¸Šå‚³ç‹€æ…‹
            currentUploadingStudentId: null
        };

        // --- å¿«å–ç®¡ç†å‡½å¼ ---
        const saveToCache = (data) => {
            try {
                localStorage.setItem(state.cacheKey, JSON.stringify(data));
                localStorage.setItem(state.cacheTimestampKey, Date.now().toString());
            } catch (error) {
                console.warn('å¿«å–å„²å­˜å¤±æ•—:', error);
            }
        };
        
        const loadFromCache = () => {
            try {
                const timestamp = localStorage.getItem(state.cacheTimestampKey);
                const cachedData = localStorage.getItem(state.cacheKey);
                
                if (!timestamp || !cachedData) return null;
                
                const age = Date.now() - parseInt(timestamp);
                if (age > state.cacheDuration) {
                    // å¿«å–éæœŸï¼Œæ¸…é™¤èˆŠå¿«å–
                    localStorage.removeItem(state.cacheKey);
                    localStorage.removeItem(state.cacheTimestampKey);
                    return null;
                }
                
                return JSON.parse(cachedData);
            } catch (error) {
                console.warn('å¿«å–è¼‰å…¥å¤±æ•—:', error);
                return null;
            }
        };
        
        const clearCache = () => {
            localStorage.removeItem(state.cacheKey);
            localStorage.removeItem(state.cacheTimestampKey);
        };

        const showCacheToast = (message, isError = false) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-3 rounded-lg text-white font-bold z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        };

        // --- é€šç”¨å‡½å¼ ---
        const toggleModal = (modal, show) => {
            modal.classList.toggle('hidden', !show);
        };

        const playSound = (soundPlayer) => {
            if (typeof Tone === 'undefined') return;
            if (Tone.context.state !== 'running') {
                Tone.start().catch(e => console.error("Tone.js context ç„¡æ³•å•Ÿå‹•", e));
            }
            try {
                soundPlayer();
            } catch (e) {
                console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e);
            }
        };

        const exportToCsv = (studentData, filename) => {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // åŠ å…¥ BOM è®“ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            csvContent += "åˆ†çµ„,å­¸ç”Ÿå§“å,ç¸½å¾—åˆ†\n";

            studentData.forEach(student => {
                const group = student.group || 'æœªåˆ†çµ„';
                csvContent += `"${group}","${student.name}",${student.points}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link); // Firefox éœ€è¦

            link.click();
            document.body.removeChild(link);
        }

        // --- æ¨‚è§€æ›´æ–°è¼”åŠ©å‡½æ•¸ ---
        const updateStudentPointsOptimistic = (studentId, pointsChange) => {
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;
            
            const oldPoints = student.points;
            const newPoints = oldPoints + pointsChange;
            
            // ç«‹å³æ›´æ–°ç‹€æ…‹
            student.points = newPoints;
            
            // ç«‹å³æ›´æ–°UI
            const pointsEl = getEl(`points-${studentId}`);
            if (pointsEl) {
                pointsEl.textContent = newPoints;
                // æ·»åŠ åŒæ­¥ä¸­æŒ‡ç¤ºå™¨
                addSyncIndicator(studentId, 'syncing');
            }
            
            return { oldPoints, newPoints };
        };

        const rollbackStudentPoints = (studentId, oldPoints) => {
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.points = oldPoints;
            const pointsEl = getEl(`points-${studentId}`);
            if (pointsEl) {
                pointsEl.textContent = oldPoints;
                pointsEl.classList.add('error-flash');
                setTimeout(() => pointsEl.classList.remove('error-flash'), 3000);
            }
        };

        const addSyncIndicator = (studentId, status) => {
            const card = document.querySelector(`[data-student-id="${studentId}"]`);
            if (!card) return;
            
            let indicator = card.querySelector('.sync-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'sync-indicator absolute top-2 right-2 w-3 h-3 rounded-full';
                card.appendChild(indicator);
            }
            
            indicator.classList.remove('bg-yellow-400', 'bg-red-400', 'bg-green-400', 'animate-pulse');
            
            if (status === 'syncing') {
                indicator.classList.add('bg-yellow-400', 'animate-pulse');
            } else if (status === 'error') {
                indicator.classList.add('bg-red-400');
            } else if (status === 'success') {
                indicator.classList.add('bg-green-400');
                setTimeout(() => indicator.remove(), 1000);
            }
        };

        const scheduleRetry = (operation, maxRetries = 3) => {
            const retryItem = { ...operation, retryCount: 0, maxRetries };
            state.retryQueue.push(retryItem);
            executeRetry(retryItem);
        };

        const executeRetry = async (retryItem) => {
            const delays = [30000, 120000, 300000]; // 30ç§’, 2åˆ†é˜, 5åˆ†é˜
            
            while (retryItem.retryCount < retryItem.maxRetries) {
                await new Promise(resolve => setTimeout(resolve, delays[retryItem.retryCount] || 300000));
                
                try {
                    retryItem.retryCount++;
                    const result = await fetchFromGAS('updatePoints', {
                        studentId: retryItem.studentId,
                        behaviorName: retryItem.behaviorName,
                        points: retryItem.points
                    });
                    
                    if (result) {
                        // é‡è©¦æˆåŠŸ
                        addSyncIndicator(retryItem.studentId, 'success');
                        state.retryQueue = state.retryQueue.filter(item => item !== retryItem);
                        return;
                    }
                } catch (error) {
                    console.error(`é‡è©¦å¤±æ•— (${retryItem.retryCount}/${retryItem.maxRetries}):`, error);
                }
            }
            
            // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
            addSyncIndicator(retryItem.studentId, 'error');
            state.retryQueue = state.retryQueue.filter(item => item !== retryItem);
        };

        // --- GAS API å‘¼å« ---
        async function fetchFromGAS(action, payload = {}, skipLoading = false) {
            if (!state.gasUrl) {
                alert('è«‹å…ˆè¨­å®š GAS ç¶²å€ï¼');
                toggleModal(app.modals.settings, true);
                return null;
            }
            
            if (!skipLoading) setLoading(true);
            try {
                const response = await fetch(state.gasUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, payload }),
                    redirect: 'follow'
                });
                
                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(`GAS Error: ${result.message}`);
                }
                return result.data;
            } catch (error) {
                console.error('Fetch GAS å¤±æ•—:', error);
                if (!skipLoading) {
                    alert(`èˆ‡ Google Sheet çš„é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}\n\nè«‹æª¢æŸ¥æ‚¨çš„ GAS ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠè©¦ç®—è¡¨æ¬Šé™æ˜¯å¦è¨­å®šç‚ºã€Œä»»ä½•äººã€ã€‚`);
                }
                throw error;
            } finally {
                if (!skipLoading) setLoading(false);
            }
        }

        // --- æ¸²æŸ“å‡½å¼ ---
        const setLoading = (isLoading) => {
            state.isLoading = isLoading;
            app.containers.initialPrompt.classList.toggle('hidden', !isLoading && state.students.length > 0);
            app.containers.loadingText.classList.toggle('hidden', !isLoading);
            app.containers.spinner.classList.toggle('hidden', !isLoading);
        };
        
        const generateAvatar = (seed) => {
            const S = (s) => { let h = 0; for(let i=0; i<s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0; return h; };
            const R = (s) => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
            const seedNum = S(seed);
            
            const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
            const bgColor = colors[Math.floor(R(seedNum) * colors.length)];
            const eyeType = Math.floor(R(seedNum+1) * 3);
            const mouthType = Math.floor(R(seedNum+2) * 3);
            
            let eyes = '';
            if (eyeType === 0) eyes = `<circle cx="35" cy="40" r="8" fill="white"/><circle cx="35" cy="40" r="4" fill="black"/><circle cx="65" cy="40" r="8" fill="white"/><circle cx="65" cy="40" r="4" fill="black"/>`;
            else if (eyeType === 1) eyes = `<rect x="28" y="35" width="15" height="10" fill="white" transform="rotate(-10 35 40)"/><rect x="60" y="35" width="15" height="10" fill="white" transform="rotate(10 65 40)"/>`;
            else eyes = `<path d="M30 45 C 35 35, 45 35, 50 45" stroke="white" stroke-width="6" fill="none"/><path d="M55 45 C 60 35, 70 35, 75 45" stroke="white" stroke-width="6" fill="none"/>`;

            let mouth = '';
            if (mouthType === 0) mouth = `<path d="M35 70 Q 50 85, 65 70" stroke="white" stroke-width="5" fill="none"/>`;
            else if (mouthType === 1) mouth = `<rect x="40" y="70" width="20" height="8" fill="white" rx="3"/>`;
            else mouth = `<circle cx="50" cy="75" r="10" fill="white"/>`;

            return `data:image/svg+xml,${encodeURIComponent(`<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="20" fill="${bgColor}" />${eyes}${mouth}</svg>`)}`;
        };

        const switchTab = (tabName) => {
            state.activeTab = tabName;
            
            // æ›´æ–°åˆ†é æ¨£å¼
            app.containers.studentsTab.classList.toggle('active-tab', tabName === 'students');
            app.containers.groupsTab.classList.toggle('active-tab', tabName === 'groups');
            
            if (tabName !== 'students') {
                app.containers.studentsTab.classList.remove('active-tab');
                app.containers.studentsTab.style.backgroundColor = '#d1d5db'; // gray-300
            }
            if (tabName !== 'groups') {
                app.containers.groupsTab.classList.remove('active-tab');
                app.containers.groupsTab.style.backgroundColor = '#d1d5db'; // gray-300
            }
            
            // é¡¯ç¤º/éš±è—å…§å®¹
            app.containers.studentsView.classList.toggle('hidden', tabName !== 'students');
            app.containers.groupsView.classList.toggle('hidden', tabName !== 'groups');
            
            if (tabName === 'groups') {
                renderGroupsGrid();
            }
        };

        const renderStudentGrid = () => {
            app.containers.studentGrid.innerHTML = '';
            if (state.students.length === 0 && !state.isLoading) {
                 app.containers.initialPrompt.classList.remove('hidden');
                 app.containers.loadingText.textContent = "ç­ç´šè£¡é‚„æ²’æœ‰å­¸ç”Ÿå–”ï¼è«‹åœ¨ç¨‹å¼ç¢¼ä¸­æ›´æ–° GAS ç¶²å€å¾Œï¼Œé»æ“Š ğŸ§‘â€ğŸ« ç®¡ç†å­¸ç”Ÿã€‚";
                 app.containers.spinner.classList.add('hidden');
                 return;
            }
            
            let sortedStudents = [...state.students];
            if (state.sortOrder === 'byName') {
                sortedStudents.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            } else if (state.sortOrder === 'byPoints') {
                sortedStudents.sort((a, b) => b.points - a.points);
            } else if (state.sortOrder === 'byGroup') {
                // å…ˆæŒ‰åˆ†çµ„æ’åºï¼Œå†æŒ‰å§“åæ’åº
                sortedStudents.sort((a, b) => {
                    const groupA = a.group || ' '; // ç„¡åˆ†çµ„çš„æ”¾åœ¨æœ€å¾Œ
                    const groupB = b.group || ' ';
                    if (groupA === groupB) {
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    }
                    return groupA.localeCompare(groupB, 'zh-Hant');
                });
            }
            
            sortedStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white border-4 border-black rounded-lg p-3 flex flex-col items-center cursor-pointer pop-shadow relative';
                card.dataset.studentId = student.id;

                const pointChangeEl = document.createElement('div');
                pointChangeEl.className = 'point-change-indicator absolute text-3xl font-anton font-bold pointer-events-none opacity-0';
                
                const avatar = document.createElement('img');
                avatar.src = student.avatar;
                avatar.alt = `${student.name} çš„é ­åƒ`;
                avatar.className = 'w-24 h-24 rounded-md border-2 border-black mb-2';

                const nameContainer = document.createElement('div');
                nameContainer.className = 'text-center w-full';
                
                if (student.group) {
                    // æœ‰åˆ†çµ„æ™‚ï¼Œé¡¯ç¤ºã€Œåˆ†çµ„åç¨± å­¸ç”Ÿå§“åã€
                    nameContainer.innerHTML = `
                        <p class="font-bold text-lg truncate">
                            <span class="text-sm text-gray-600 font-normal">${student.group}</span>
                            <span class="ml-1">${student.name}</span>
                        </p>
                    `;
                } else {
                    // ç„¡åˆ†çµ„æ™‚ï¼Œåªé¡¯ç¤ºå­¸ç”Ÿå§“å
                    nameContainer.innerHTML = `
                        <p class="font-bold text-center text-lg truncate w-full">${student.name}</p>
                    `;
                }

                const points = document.createElement('p');
                points.className = 'font-anton text-4xl text-blue-600';
                points.textContent = student.points;
                points.id = `points-${student.id}`;
                
                card.append(pointChangeEl, avatar, nameContainer, points);
                card.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openPointsModal(student.id);
                });
                app.containers.studentGrid.appendChild(card);
            });
        };

        const renderGroupsGrid = () => {
            app.containers.groupsGrid.innerHTML = '';
            
            // æ•´ç†åˆ†çµ„è³‡æ–™
            const groups = {};
            state.students.forEach(student => {
                const groupName = student.group || 'æœªåˆ†çµ„';
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(student);
            });
            
            if (Object.keys(groups).length === 0) {
                app.containers.groupsGrid.innerHTML = '<p class="text-center text-gray-600 p-8 col-span-full">æ²’æœ‰åˆ†çµ„è³‡æ–™ã€‚</p>';
                return;
            }
            
            const groupColors = [
                'from-pink-300 to-purple-300',
                'from-blue-300 to-indigo-300', 
                'from-green-300 to-teal-300',
                'from-yellow-300 to-orange-300',
                'from-red-300 to-pink-300',
                'from-purple-300 to-violet-300',
                'from-cyan-300 to-blue-300',
                'from-lime-300 to-green-300'
            ];
            
            Object.entries(groups).forEach(([groupName, students], index) => {
                const groupCard = document.createElement('div');
                const colorClass = groupColors[index % groupColors.length];
                groupCard.className = `group-card bg-gradient-to-br ${colorClass} border-4 border-black rounded-lg p-4 cursor-pointer pop-shadow`;
                
                const groupTitle = document.createElement('h3');
                groupTitle.className = 'font-anton text-2xl mb-3 text-center';
                groupTitle.textContent = groupName;
                
                const studentList = document.createElement('div');
                studentList.className = 'mb-3';
                
                const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
                const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
                
                students.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'flex justify-between items-center py-1 px-2 bg-white/30 rounded mb-1';
                    studentItem.innerHTML = `
                        <span class="font-bold">${student.name}</span>
                        <span class="font-anton text-lg text-blue-600">${student.points}</span>
                    `;
                    studentList.appendChild(studentItem);
                });
                
                const groupStats = document.createElement('div');
                groupStats.className = 'text-center border-t-2 border-black pt-2';
                groupStats.innerHTML = `
                    <p class="text-sm"><span class="font-bold">äººæ•¸:</span> ${students.length}</p>
                    <p class="text-sm"><span class="font-bold">ç¸½åˆ†:</span> ${totalPoints}</p>
                    <p class="text-sm"><span class="font-bold">å¹³å‡:</span> ${avgPoints}</p>
                `;
                
                groupCard.append(groupTitle, studentList, groupStats);
                groupCard.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openGroupPointsModal(groupName, students);
                });
                
                app.containers.groupsGrid.appendChild(groupCard);
            });
        };
        
        const renderStudentDeletionList = () => {
            app.containers.deleteStudentList.innerHTML = '';
            if (state.students.length === 0) {
                app.containers.deleteStudentList.innerHTML = '<p class="text-center text-gray-600 p-4">ç›®å‰æ²’æœ‰å­¸ç”Ÿå¯åˆªé™¤ã€‚</p>';
                return;
            }
            
            let sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

            sortedStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/50 p-2 rounded-md';
                item.innerHTML = `
                    <span class="font-bold">${student.name}</span>
                    <button data-id="${student.id}" class="delete-student-btn pop-button bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md border-2 border-black">åˆªé™¤</button>
                `;
                app.containers.deleteStudentList.appendChild(item);
            });
            
            // ç‚ºæ‰€æœ‰æ–°çš„åˆªé™¤æŒ‰éˆ•åŠ ä¸Šäº‹ä»¶ç›£è½
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', handleDeleteStudent);
            });
        };

        // --- Modal é–‹å•Ÿ/é—œé–‰é‚è¼¯ ---
        const openManageStudentModal = () => {
            playSound(app.sounds.click);
            app.inputs.studentName.value = '';
            renderStudentDeletionList();
            toggleModal(app.modals.manageStudent, true);
            app.inputs.studentName.focus();
        };

        const openGroupPointsModal = (groupName, students) => {
            // å®¶é•·æ¨¡å¼ä¸‹ä¸å…è¨±é–‹å•Ÿåˆ†çµ„é»æ•¸modal
            if (!state.isTeacherMode) return;
            
            state.currentGroupName = groupName;
            state.currentStudentId = null;
            
            app.titles.pointsModal.textContent = `çµ¦ ${groupName} é»æ•¸`;
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';

            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full pop-button pop-shadow-sm border-2 border-black rounded-md p-3 font-bold text-left flex justify-between items-center`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl">${pointsText}</span>`;
                
                if (b.type === 'positive') {
                    btn.classList.add('bg-green-400');
                    app.containers.positiveBehaviors.appendChild(btn);
                } else {
                    btn.classList.add('bg-red-400');
                    app.containers.negativeBehaviors.appendChild(btn);
                }
                btn.addEventListener('click', () => awardGroupPoints(b, students));
            });
            
            // éš±è—æ­·å²ç´€éŒ„æŒ‰éˆ•ï¼Œå› ç‚ºé€™æ˜¯åˆ†çµ„æ¨¡å¼
            app.buttons.viewHistory.style.display = 'none';
            
            toggleModal(app.modals.points, true);
        };

        const awardGroupPoints = async (behavior, students) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);

            // ç«‹å³é—œé–‰modal
            toggleModal(app.modals.points, false);
            
            // æ¨‚è§€æ›´æ–°ï¼šç«‹å³æ›´æ–°æ‰€æœ‰å­¸ç”Ÿåˆ†æ•¸
            const oldPointsMap = new Map();
            students.forEach(student => {
                const result = updateStudentPointsOptimistic(student.id, Number(points));
                if (result) {
                    oldPointsMap.set(student.id, result.oldPoints);
                }
            });
            
            // é‡æ–°æ¸²æŸ“ç•«é¢
            if (state.activeTab === 'groups') {
                renderGroupsGrid();
            }
            if (state.activeTab === 'students') {
                renderStudentGrid();
            }
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            const successToast = document.createElement('div');
            successToast.className = 'fixed top-4 right-4 bg-green-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
            successToast.textContent = `å·²ç‚º ${state.currentGroupName} çš„ ${students.length} ä½å­¸ç”ŸåŠ æ‰£ ${points > 0 ? '+' : ''}${points} åˆ†ï¼`;
            document.body.appendChild(successToast);
            setTimeout(() => document.body.removeChild(successToast), 3000);
            
            // èƒŒæ™¯æ‰¹é‡åŒæ­¥åˆ° Google Sheets
            try {
                // æº–å‚™æ‰¹é‡æ›´æ–°è³‡æ–™
                const updates = students.map(student => ({
                    studentId: student.id,
                    behaviorName: `[åˆ†çµ„] ${name}`,
                    points: Number(points)
                }));
                
                // æ‰¹é‡æ›´æ–°åˆ†æ•¸
                const data = await fetchFromGAS('updateMultiplePoints', { updates }, true); // skipLoading = true
                
                if (data && data.updatedStudents) {
                    // åŒæ­¥æˆåŠŸï¼Œç‚ºæ‰€æœ‰å­¸ç”Ÿæ·»åŠ æˆåŠŸæŒ‡ç¤ºå™¨
                    students.forEach(student => {
                        addSyncIndicator(student.id, 'success');
                    });
                    
                    // æª¢æŸ¥ä¸¦ä¿®æ­£ä»»ä½•ä¸ä¸€è‡´çš„æ•¸æ“š
                    data.updatedStudents.forEach(updated => {
                        const stateStudent = state.students.find(s => s.id === updated.studentId);
                        if (stateStudent && stateStudent.points !== updated.newPoints) {
                            stateStudent.points = updated.newPoints;
                            const pointsEl = getEl(`points-${updated.studentId}`);
                            if (pointsEl) pointsEl.textContent = updated.newPoints;
                        }
                    });
                    
                    // é‡æ–°æ¸²æŸ“ä»¥åæ˜ ä»»ä½•ä¿®æ­£
                    if (state.activeTab === 'groups') {
                        renderGroupsGrid();
                    }
                    if (state.activeTab === 'students') {
                        renderStudentGrid();
                    }
                } else {
                    throw new Error('æ‰¹é‡åŒæ­¥å¤±æ•—');
                }
            } catch (error) {
                console.error('æ‰¹é‡æ›´æ–°åˆ†æ•¸å¤±æ•—:', error);
                
                // å›æ»¾æ‰€æœ‰å­¸ç”Ÿçš„åˆ†æ•¸
                students.forEach(student => {
                    const oldPoints = oldPointsMap.get(student.id);
                    if (oldPoints !== undefined) {
                        rollbackStudentPoints(student.id, oldPoints);
                        addSyncIndicator(student.id, 'error');
                        
                        // å®‰æ’å€‹åˆ¥é‡è©¦
                        scheduleRetry({
                            studentId: student.id,
                            behaviorName: `[åˆ†çµ„] ${name}`,
                            points: Number(points)
                        });
                    }
                });
                
                // é‡æ–°æ¸²æŸ“
                if (state.activeTab === 'groups') {
                    renderGroupsGrid();
                }
                if (state.activeTab === 'students') {
                    renderStudentGrid();
                }
                
                // é¡¯ç¤ºéŒ¯èª¤æç¤º
                const errorToast = document.createElement('div');
                errorToast.className = 'fixed top-4 right-4 bg-red-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                errorToast.textContent = 'æ‰¹é‡åŒæ­¥å¤±æ•—ï¼Œå°‡è‡ªå‹•é‡è©¦';
                document.body.appendChild(errorToast);
                setTimeout(() => document.body.removeChild(errorToast), 3000);
            }
        };

        const openPointsModal = (studentId) => {
            // å®¶é•·æ¨¡å¼ä¸‹ä¸å…è¨±é–‹å•Ÿé»æ•¸modal
            if (!state.isTeacherMode) return;
            
            state.currentStudentId = studentId;
            state.currentGroupName = null;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            app.titles.pointsModal.textContent = `çµ¦ ${student.name} é»æ•¸`;
            
            // é¡¯ç¤ºæ­·å²ç´€éŒ„æŒ‰éˆ•
            app.buttons.viewHistory.style.display = 'inline-block';
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';

            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full pop-button pop-shadow-sm border-2 border-black rounded-md p-3 font-bold text-left flex justify-between items-center`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl">${pointsText}</span>`;
                
                if (b.type === 'positive') {
                    btn.classList.add('bg-green-400');
                    app.containers.positiveBehaviors.appendChild(btn);
                } else {
                    btn.classList.add('bg-red-400');
                    app.containers.negativeBehaviors.appendChild(btn);
                }
                btn.addEventListener('click', () => awardPoints(b));
            });
            toggleModal(app.modals.points, true);
        };

        const awardPoints = async (behavior) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);

            // ç«‹å³é—œé–‰modalï¼Œä¸å†é˜»æ“‹ç”¨æˆ¶æ“ä½œ
            toggleModal(app.modals.points, false);

            // é¡¯ç¤ºé»æ•¸è®ŠåŒ–å‹•ç•«
            const studentCard = document.querySelector(`[data-student-id="${state.currentStudentId}"]`);
            if(studentCard) {
                const indicator = studentCard.querySelector('.point-change-indicator');
                indicator.textContent = points > 0 ? `+${points}` : points;
                indicator.className = 'point-change-indicator absolute text-3xl font-anton font-bold pointer-events-none opacity-0';
                void indicator.offsetWidth;
                indicator.classList.add(points > 0 ? 'point-change-up' : 'point-change-down');
            }

            // æ¨‚è§€æ›´æ–°ï¼šç«‹å³æ›´æ–°ç•«é¢åˆ†æ•¸
            const optimisticResult = updateStudentPointsOptimistic(state.currentStudentId, Number(points));
            if (!optimisticResult) return;

            const { oldPoints } = optimisticResult;

            // èƒŒæ™¯åŒæ­¥åˆ° Google Sheets (ä¸é˜»æ“‹UI)
            try {
                const data = await fetchFromGAS('updatePoints', { 
                    studentId: state.currentStudentId, 
                    behaviorName: name, 
                    points: Number(points) 
                }, true); // skipLoading = true
                
                if (data) {
                    // åŒæ­¥æˆåŠŸ
                    addSyncIndicator(state.currentStudentId, 'success');
                    // ç¢ºä¿ä¼ºæœå™¨è¿”å›çš„åˆ†æ•¸èˆ‡æœ¬åœ°ä¸€è‡´
                    const student = state.students.find(s => s.id === data.studentId);
                    if (student && student.points !== data.newPoints) {
                        // å¦‚æœä¸ä¸€è‡´ï¼Œä»¥ä¼ºæœå™¨ç‚ºæº–
                        student.points = data.newPoints;
                        const pointsEl = getEl(`points-${data.studentId}`);
                        if (pointsEl) pointsEl.textContent = data.newPoints;
                    }
                } else {
                    throw new Error('åŒæ­¥å¤±æ•—');
                }
            } catch (error) {
                console.error('åŒæ­¥åˆ°Google Sheetså¤±æ•—:', error);
                
                // å›æ»¾æ“ä½œ
                rollbackStudentPoints(state.currentStudentId, oldPoints);
                addSyncIndicator(state.currentStudentId, 'error');
                
                // å®‰æ’é‡è©¦
                scheduleRetry({
                    studentId: state.currentStudentId,
                    behaviorName: name,
                    points: Number(points)
                });
                
                // é¡¯ç¤ºæº«å’Œçš„éŒ¯èª¤æç¤º
                const errorToast = document.createElement('div');
                errorToast.className = 'fixed top-4 right-4 bg-red-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                errorToast.textContent = 'åŒæ­¥å¤±æ•—ï¼Œå°‡è‡ªå‹•é‡è©¦';
                document.body.appendChild(errorToast);
                setTimeout(() => document.body.removeChild(errorToast), 3000);
            }
        };
        
        const openHistoryModal = async () => {
            const student = state.students.find(s => s.id === state.currentStudentId);
            app.titles.historyModal.textContent = `${student.name} çš„æ­·å²ç´€éŒ„`;
            app.containers.historyList.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
            toggleModal(app.modals.history, true);
            
            const history = await fetchFromGAS('getHistory', { studentId: state.currentStudentId });
            if (history) {
                app.containers.historyList.innerHTML = '';
                if (history.length === 0) {
                    app.containers.historyList.innerHTML = '<p class="text-center p-4">æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>';
                    return;
                }
                history.forEach(log => {
                    const item = document.createElement('div');
                    item.className = `p-2 rounded-md mb-2 flex justify-between items-center ${log.points > 0 ? 'bg-green-200' : 'bg-red-200'}`;
                    const pointsText = log.points > 0 ? `+${log.points}` : log.points;
                    item.innerHTML = `
                        <div>
                            <p class="font-bold">${log.behaviorName}</p>
                            <p class="text-sm text-gray-600">${log.timestamp}</p>
                        </div>
                        <p class="font-anton text-2xl ${log.points > 0 ? 'text-green-700' : 'text-red-700'}">${pointsText}</p>
                    `;
                    app.containers.historyList.appendChild(item);
                });
            }
        };

        const openManageBehaviorsModal = () => {
            app.containers.behaviorListEditor.innerHTML = '';
            state.behaviors.forEach((b, index) => {
                addBehaviorEditorRow(b, index);
            });
            toggleModal(app.modals.manageBehaviors, true);
        };

        const addBehaviorEditorRow = (behavior = { name: '', points: 1, type: 'positive' }, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-white/60 rounded-md border-2 border-black';
            div.innerHTML = `
                <input type="text" value="${behavior.name}" class="behavior-name-input flex-grow p-2 border-2 border-black rounded-md" placeholder="è¡Œç‚ºåç¨±">
                <input type="number" value="${behavior.points}" class="behavior-points-input w-20 p-2 border-2 border-black rounded-md" placeholder="é»æ•¸">
                <select class="behavior-type-select p-2 border-2 border-black rounded-md bg-white">
                    <option value="positive" ${behavior.type === 'positive' ? 'selected' : ''}>åŠ åˆ†</option>
                    <option value="negative" ${behavior.type === 'negative' ? 'selected' : ''}>æ‰£åˆ†</option>
                </select>
                <button class="remove-behavior-btn text-red-600 font-bold text-2xl p-1 hover:bg-red-200 rounded-full">âœ–</button>
            `;
            app.containers.behaviorListEditor.appendChild(div);
            div.querySelector('.remove-behavior-btn').addEventListener('click', () => div.remove());
        };

        // --- åœ–ç‰‡å£“ç¸®åŠŸèƒ½ ---
        const compressImage = (file, maxWidth = 200) => {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // è¨ˆç®—å£“ç¸®å¾Œçš„å°ºå¯¸
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
                    
                    // è¨­å®šcanvaså°ºå¯¸
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // ç¹ªè£½å£“ç¸®å¾Œçš„åœ–ç‰‡
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // è½‰æ›ç‚ºbase64
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        };

        // --- é ­åƒç®¡ç†åŠŸèƒ½ ---
        const openAvatarsModal = () => {
            playSound(app.sounds.click);
            renderAvatarGrid();
            toggleModal(app.modals.manageAvatars, true);
        };

        const renderAvatarGrid = () => {
            app.containers.avatarGrid.innerHTML = '';
            
            if (state.students.length === 0) {
                app.containers.avatarGrid.innerHTML = '<p class="text-center text-gray-600 p-8 col-span-full">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ã€‚</p>';
                return;
            }
            
            // æŒ‰åå­—æ’åº
            const sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            
            sortedStudents.forEach(student => {
                const avatarCard = document.createElement('div');
                avatarCard.className = 'bg-white border-2 border-black rounded-lg p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors';
                avatarCard.innerHTML = `
                    <div class="relative mb-2">
                        <img src="${student.avatar}" alt="${student.name}" class="w-16 h-16 mx-auto rounded-md border-2 border-gray-300">
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 hover:bg-opacity-30 transition-all rounded-md">
                            <span class="text-white text-xs opacity-0 hover:opacity-100">é»æ“Šä¸Šå‚³</span>
                        </div>
                    </div>
                    <p class="font-bold text-sm">${student.name}</p>
                    <p class="text-xs text-gray-500">${student.group || 'æœªåˆ†çµ„'}</p>
                `;
                
                avatarCard.addEventListener('click', () => {
                    state.currentUploadingStudentId = student.id;
                    app.inputs.avatarFile.click();
                });
                
                app.containers.avatarGrid.appendChild(avatarCard);
            });
        };

        const handleAvatarUpload = async (event) => {
            const file = event.target.files[0];
            if (!file || !state.currentUploadingStudentId) return;
            
            const student = state.students.find(s => s.id === state.currentUploadingStudentId);
            if (!student) return;
            
            try {
                // é¡¯ç¤ºä¸Šå‚³ä¸­ç‹€æ…‹
                const uploadToast = document.createElement('div');
                uploadToast.className = 'fixed top-4 right-4 bg-blue-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                uploadToast.textContent = `æ­£åœ¨ç‚º ${student.name} ä¸Šå‚³é ­åƒ...`;
                document.body.appendChild(uploadToast);
                
                // å£“ç¸®åœ–ç‰‡
                const compressedImage = await compressImage(file, 200);
                
                // æ›´æ–°å­¸ç”Ÿé ­åƒï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
                const oldAvatar = student.avatar;
                student.avatar = compressedImage;
                
                // ç«‹å³æ›´æ–°UI
                renderAvatarGrid();
                renderStudentGrid();
                
                // åŒæ­¥åˆ°Google Sheets
                const result = await fetchFromGAS('updateStudentAvatar', {
                    studentId: state.currentUploadingStudentId,
                    avatar: compressedImage
                }, true);
                
                document.body.removeChild(uploadToast);
                
                if (result && result.success) {
                    // æˆåŠŸæç¤º
                    const successToast = document.createElement('div');
                    successToast.className = 'fixed top-4 right-4 bg-green-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                    successToast.textContent = `${student.name} çš„é ­åƒå·²æ›´æ–°ï¼`;
                    document.body.appendChild(successToast);
                    setTimeout(() => document.body.removeChild(successToast), 3000);
                    
                    // æ¸…é™¤å¿«å–
                    clearCache();
                } else {
                    throw new Error('ä¸Šå‚³å¤±æ•—');
                }
                
            } catch (error) {
                console.error('é ­åƒä¸Šå‚³å¤±æ•—:', error);
                
                // å›å¾©åŸé ­åƒ
                student.avatar = oldAvatar;
                renderAvatarGrid();
                renderStudentGrid();
                
                // éŒ¯èª¤æç¤º
                const errorToast = document.createElement('div');
                errorToast.className = 'fixed top-4 right-4 bg-red-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                errorToast.textContent = `${student.name} é ­åƒä¸Šå‚³å¤±æ•—`;
                document.body.appendChild(errorToast);
                setTimeout(() => document.body.removeChild(errorToast), 3000);
            }
            
            // æ¸…é™¤æ–‡ä»¶é¸æ“‡
            event.target.value = '';
            state.currentUploadingStudentId = null;
        };

        // --- äº‹ä»¶è™•ç† ---
        const handleAddStudents = async () => {
            const lines = app.inputs.studentName.value.trim().split('\n').map(n => n.trim()).filter(n => n);
            if (lines.length > 0) {
                playSound(app.sounds.click);
                const studentsPayload = lines.map(line => {
                    // æ”¯æ´ tab æˆ–é€—è™Ÿåˆ†éš”çš„å§“å+åˆ†çµ„æ ¼å¼
                    let name, group = '';
                    if (line.includes('\t')) {
                        [name, group] = line.split('\t').map(s => s.trim());
                    } else if (line.includes(',')) {
                        [name, group] = line.split(',').map(s => s.trim());
                    } else {
                        name = line;
                    }
                    return { name, group, avatar: generateAvatar(name) };
                });
                const newStudents = await fetchFromGAS('addMultipleStudents', { students: studentsPayload });
                if (newStudents) {
                    state.students.push(...newStudents);
                    
                    // å¦‚æœé€™æ˜¯ç¬¬ä¸€æ¬¡æ–°å¢å­¸ç”Ÿï¼Œé¡¯ç¤ºåˆ†é 
                    if (state.students.length === newStudents.length) {
                        app.containers.tabsContainer.classList.remove('hidden');
                    }
                    
                    renderStudentGrid();
                    renderStudentDeletionList();
                    app.inputs.studentName.value = '';
                    
                    // æ¸…é™¤å¿«å–ï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
                    clearCache();
                    
                    alert(`${lines.length} ä½å­¸ç”Ÿå·²æˆåŠŸæ–°å¢ï¼`);
                }
            } else {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å­¸ç”Ÿå§“åï¼');
            }
        };
        
        const handleDeleteStudent = async (event) => {
            const studentId = event.target.dataset.id;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            playSound(app.sounds.negative);
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                const result = await fetchFromGAS('deleteStudent', { studentId });
                if (result && result.deletedStudentId) {
                    state.students = state.students.filter(s => s.id !== result.deletedStudentId);
                    renderStudentGrid();
                    renderStudentDeletionList();
                    
                    // æ¸…é™¤å¿«å–ï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
                    clearCache();
                    
                    alert(`å­¸ç”Ÿã€Œ${student.name}ã€å·²åˆªé™¤ã€‚`);
                }
            }
        };

        // --- å®¶é•·æ¨¡å¼é€£çµç”ŸæˆåŠŸèƒ½ ---
        const generateParentLink = () => {
            const currentUrl = window.location.href.split('?')[0]; // ç§»é™¤ç¾æœ‰åƒæ•¸
            return currentUrl; // é è¨­å°±æ˜¯å®¶é•·æ¨¡å¼ï¼Œä¸éœ€è¦åƒæ•¸
        };

        const openParentLinkModal = () => {
            playSound(app.sounds.click);
            const parentUrl = generateParentLink();
            
            // è¨­å®šç¶²å€é¡¯ç¤º
            getEl('parent-url-display').value = parentUrl;
            
            // ç”ŸæˆQRç¢¼
            const canvas = getEl('qr-canvas');
            try {
                // æª¢æŸ¥QRç¢¼åº«æ˜¯å¦è¼‰å…¥
                if (typeof qrcode === 'undefined') {
                    throw new Error('QRç¢¼åº«æœªè¼‰å…¥');
                }
                
                // ä½¿ç”¨qrcode-generatoråº«
                const qr = qrcode(0, 'M');
                qr.addData(parentUrl);
                qr.make();
                
                // è¨­å®šcanvaså¤§å°
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // æ¸…é™¤canvas
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 200, 200);
                
                // ç¹ªè£½QRç¢¼
                const modules = qr.getModuleCount();
                const cellSize = 200 / modules;
                
                ctx.fillStyle = '#000000';
                for (let row = 0; row < modules; row++) {
                    for (let col = 0; col < modules; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
            } catch (error) {
                console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = '#374151';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('QRç¢¼ç”Ÿæˆå¤±æ•—', 100, 90);
                ctx.fillText('è«‹è¤‡è£½é€£çµä½¿ç”¨', 100, 110);
            }
            
            toggleModal(app.modals.parentLink, true);
        };

        const copyParentUrl = async () => {
            const urlInput = getEl('parent-url-display');
            try {
                await navigator.clipboard.writeText(urlInput.value);
                const btn = app.buttons.copyParentUrl;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.backgroundColor = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '';
                }, 2000);
                playSound(app.sounds.positive);
            } catch (error) {
                console.error('è¤‡è£½å¤±æ•—:', error);
                // å‚™ç”¨æ–¹æ¡ˆï¼šé¸å–æ–‡å­—
                urlInput.select();
                urlInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    alert('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                } catch (e) {
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµã€‚');
                }
            }
        };

        // --- äº‹ä»¶ç›£è½ ---
        // æ•™å¸«æ¨¡å¼æŒ‰éˆ•ï¼ˆåªåœ¨æ•™å¸«æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰
        if (state.isTeacherMode) {
            app.buttons.parentLink.addEventListener('click', openParentLinkModal);
            app.buttons.copyParentUrl.addEventListener('click', copyParentUrl);
            app.buttons.closeParentLink.addEventListener('click', () => toggleModal(app.modals.parentLink, false));
        } else {
            // å®¶é•·æ¨¡å¼ä¸‹éš±è—ç®¡ç†ç›¸é—œæŒ‰éˆ•
            app.buttons.parentLink.style.display = 'none';
            app.buttons.teacherPanel.style.display = 'none';
            app.buttons.help.style.display = 'none';
        }
        
        // åˆ†é åˆ‡æ›
        app.containers.studentsTab.addEventListener('click', () => {
            playSound(app.sounds.click);
            switchTab('students');
        });
        app.containers.groupsTab.addEventListener('click', () => {
            playSound(app.sounds.click);
            switchTab('groups');
        });
        
        app.buttons.sort.addEventListener('click', () => {
            playSound(app.sounds.click);
            // å¾ªç’°åˆ‡æ›æ’åºæ–¹å¼ï¼šå§“å -> åˆ†æ•¸ -> åˆ†çµ„ -> å§“å
            if (state.sortOrder === 'byName') {
                state.sortOrder = 'byPoints';
            } else if (state.sortOrder === 'byPoints') {
                state.sortOrder = 'byGroup';
            } else {
                state.sortOrder = 'byName';
            }
            
            // æ›´æ–°æ’åºæŒ‰éˆ•é¡¯ç¤º
            const sortButton = app.buttons.sort;
            if (state.sortOrder === 'byName') {
                sortButton.textContent = 'â˜…'; // æ˜Ÿè¨˜è™Ÿè¡¨ç¤ºæŒ‰å§“å
                sortButton.title = 'ç›®å‰ï¼šæŒ‰å§“åæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºæŒ‰åˆ†æ•¸æ’åº';
            } else if (state.sortOrder === 'byPoints') {
                sortButton.textContent = 'â†‘'; // ä¸Šç®­é ­è¡¨ç¤ºæŒ‰åˆ†æ•¸
                sortButton.title = 'ç›®å‰ï¼šæŒ‰åˆ†æ•¸æ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºæŒ‰åˆ†çµ„æ’åº';
            } else {
                sortButton.textContent = 'ğŸ“Š'; // åœ–è¡¨è¡¨ç¤ºæŒ‰åˆ†çµ„
                sortButton.title = 'ç›®å‰ï¼šæŒ‰åˆ†çµ„æ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºæŒ‰å§“åæ’åº';
            }
            
            renderStudentGrid();
        });

        app.buttons.teacherPanel.addEventListener('click', () => {
            playSound(app.sounds.click);
            if (!app.containers.controlPanel.classList.contains('hidden')) {
                app.containers.controlPanel.classList.add('hidden');
                app.containers.controlPanel.classList.remove('flex');
            } else {
                app.containers.controlPanel.classList.remove('hidden');
                app.containers.controlPanel.classList.add('flex');
            }
        });

        
        // app.buttons.settings.addEventListener('click', () => {
        //     playSound(app.sounds.click);
        //     app.inputs.gasUrl.value = state.gasUrl;
        //     toggleModal(app.modals.settings, true);
        // }); // å·²ç¦ç”¨è¨­å®šåŠŸèƒ½
        // app.buttons.cancelSettings.addEventListener('click', () => toggleModal(app.modals.settings, false)); // å·²ç¦ç”¨è¨­å®šåŠŸèƒ½
        // app.buttons.saveSettings.addEventListener('click', () => {
        //     playSound(app.sounds.click);
        //     state.gasUrl = app.inputs.gasUrl.value.trim();
        //     localStorage.setItem('gasUrl', state.gasUrl);
        //     toggleModal(app.modals.settings, false);
        //     init();
        // }); // å·²ç¦ç”¨è¨­å®šåŠŸèƒ½

        app.buttons.help.addEventListener('click', () => {
            playSound(app.sounds.click);
            toggleModal(app.modals.help, true);
        });
        app.buttons.closeHelp.addEventListener('click', () => toggleModal(app.modals.help, false));
        
        app.buttons.copyGasCode.addEventListener('click', () => {
            const code = getEl('gas-code-block').innerText;
            navigator.clipboard.writeText(code).then(() => {
                app.buttons.copyGasCode.textContent = 'å·²è¤‡è£½ï¼';
                setTimeout(() => { app.buttons.copyGasCode.textContent = 'è¤‡è£½'; }, 2000);
            }).catch(err => alert('è¤‡è£½å¤±æ•—: ' + err));
        });

        app.buttons.manageStudent.addEventListener('click', openManageStudentModal);
        app.buttons.closeManageStudent.addEventListener('click', () => toggleModal(app.modals.manageStudent, false));
        app.buttons.confirmAddStudent.addEventListener('click', handleAddStudents);
        
        app.buttons.manageAvatars.addEventListener('click', openAvatarsModal);
        app.buttons.closeAvatars.addEventListener('click', () => toggleModal(app.modals.manageAvatars, false));
        app.inputs.avatarFile.addEventListener('change', handleAvatarUpload);

        app.buttons.exportGrades.addEventListener('click', () => {
            playSound(app.sounds.click);
            toggleModal(app.modals.export, true);
        });
        app.buttons.cancelExport.addEventListener('click', () => {
            toggleModal(app.modals.export, false);
        });
        app.buttons.exportOriginal.addEventListener('click', () => {
            playSound(app.sounds.click);
            const originalOrderStudents = [...state.students].sort((a, b) => {
                const groupA = a.group || 'æœªåˆ†çµ„';
                const groupB = b.group || 'æœªåˆ†çµ„';
                if (groupA === groupB) {
                    return a.name.localeCompare(b.name, 'zh-Hant');
                }
                return groupA.localeCompare(groupB, 'zh-Hant');
            });
            const filename = `${state.className}_æˆç¸¾(åˆ†çµ„å§“åé †åº).csv`;
            exportToCsv(originalOrderStudents, filename);
            toggleModal(app.modals.export, false);
        });
        app.buttons.exportSorted.addEventListener('click', () => {
            playSound(app.sounds.click);
            const sortedStudents = [...state.students].sort((a, b) => b.points - a.points);
            const filename = `${state.className}_æˆç¸¾(åˆ†æ•¸æ’åº).csv`;
            exportToCsv(sortedStudents, filename);
            toggleModal(app.modals.export, false);
        });

        app.buttons.closePoints.addEventListener('click', () => toggleModal(app.modals.points, false));
        app.buttons.viewHistory.addEventListener('click', () => {
            playSound(app.sounds.click);
            toggleModal(app.modals.points, false);
            openHistoryModal();
        });
        app.buttons.closeHistory.addEventListener('click', () => toggleModal(app.modals.history, false));

        app.buttons.resetPoints.addEventListener('click', async () => {
            playSound(app.sounds.negative);
            if (confirm('ç¢ºå®šè¦å°‡æ‰€æœ‰å­¸ç”Ÿçš„é»æ•¸é‡è¨­ç‚º 0 å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                const result = await fetchFromGAS('resetAllPoints');
                if (result && result.success) {
                    state.students.forEach(s => s.points = 0);
                    renderStudentGrid();
                    
                    // æ¸…é™¤å¿«å–ï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
                    clearCache();
                    
                    alert('æ‰€æœ‰é»æ•¸å·²æˆåŠŸé‡è¨­ï¼');
                }
            }
        });
        
        app.buttons.manageBehaviors.addEventListener('click', () => {
            playSound(app.sounds.click);
            openManageBehaviorsModal();
        });
        app.buttons.cancelBehaviors.addEventListener('click', () => toggleModal(app.modals.manageBehaviors, false));
        app.buttons.addNewBehavior.addEventListener('click', () => addBehaviorEditorRow());
        app.buttons.saveBehaviors.addEventListener('click', async () => {
            const newBehaviors = [];
            const rows = app.containers.behaviorListEditor.querySelectorAll('.flex.items-center.gap-2');
            let isValid = true;
            rows.forEach(row => {
                const name = row.querySelector('.behavior-name-input').value.trim();
                const points = row.querySelector('.behavior-points-input').value;
                const type = row.querySelector('.behavior-type-select').value;
                if (!name || points === '') {
                    isValid = false;
                }
                newBehaviors.push({ name: name, points: Number(points), type: type });
            });

            if (!isValid) {
                alert('è¡Œç‚ºåç¨±å’Œé»æ•¸ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            
            playSound(app.sounds.click);
            const result = await fetchFromGAS('manageBehaviors', { behaviors: newBehaviors });
            if (result && result.success) {
                state.behaviors = newBehaviors;
                toggleModal(app.modals.manageBehaviors, false);
                
                // æ¸…é™¤å¿«å–ï¼Œç¢ºä¿è³‡æ–™åŒæ­¥
                clearCache();
                
                alert('è¡Œç‚ºé …ç›®å·²æ›´æ–°ï¼');
            }
        });

        // --- åˆå§‹åŒ– ---
        const init = async (forceRefresh = false) => {
            if (state.gasUrl && state.gasUrl !== 'demo') {
                app.containers.setupPrompt.classList.add('hidden');
                
                // é¦–å…ˆå˜—è©¦è¼‰å…¥å¿«å–è³‡æ–™
                if (!forceRefresh) {
                    const cachedData = loadFromCache();
                    if (cachedData) {
                        console.log('å¾å¿«å–è¼‰å…¥è³‡æ–™');
                        state.className = cachedData.className;
                        state.students = cachedData.students || [];
                        state.behaviors = cachedData.behaviors || [];
                        app.titles.className.textContent = state.className;
                        
                        // å¦‚æœæœ‰å­¸ç”Ÿï¼Œé¡¯ç¤ºåˆ†é 
                        if (state.students.length > 0) {
                            app.containers.tabsContainer.classList.remove('hidden');
                        }
                        
                        renderStudentGrid();
                        setLoading(false);
                        
                        // é¡¯ç¤ºå¿«å–è¼‰å…¥æˆåŠŸçš„æç¤º
                        showCacheToast('å¿«å–è¼‰å…¥å®Œæˆï¼èƒŒæ™¯æª¢æŸ¥æ›´æ–°ä¸­...');
                        
                        // èƒŒæ™¯æª¢æŸ¥æ›´æ–°
                        setTimeout(() => loadDataFromServer(true), 100);
                        return;
                    }
                }
                
                // æ²’æœ‰å¿«å–æˆ–å¼·åˆ¶åˆ·æ–°ï¼Œé¡¯ç¤ºè¼‰å…¥å‹•ç•«
                setLoading(true);
                await loadDataFromServer(false);
                
            } else {
                setLoading(false);
                app.containers.initialPrompt.classList.remove('hidden');
                app.containers.loadingText.classList.add('hidden');
                app.containers.spinner.classList.add('hidden');
                app.containers.setupPrompt.classList.remove('hidden');
            }
        };

        const loadDataFromServer = async (isBackgroundUpdate = false) => {
            try {
                const data = await fetchFromGAS('loadData', {}, isBackgroundUpdate);
                if (data) {
                    // æª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰è®Šæ›´
                    const cachedData = loadFromCache();
                    const hasChanged = !cachedData || 
                                     JSON.stringify(data.students) !== JSON.stringify(cachedData.students) ||
                                     JSON.stringify(data.behaviors) !== JSON.stringify(cachedData.behaviors) ||
                                     data.className !== cachedData.className;
                    
                    if (hasChanged || !isBackgroundUpdate) {
                        state.className = data.className;
                        state.students = data.students || [];
                        state.behaviors = data.behaviors || [];
                        app.titles.className.textContent = state.className;
                        
                        // å¦‚æœæœ‰å­¸ç”Ÿï¼Œé¡¯ç¤ºåˆ†é 
                        if (state.students.length > 0) {
                            app.containers.tabsContainer.classList.remove('hidden');
                        }
                        
                        renderStudentGrid();
                        
                        // å„²å­˜åˆ°å¿«å–
                        saveToCache(data);
                        
                        if (isBackgroundUpdate && hasChanged) {
                            showCacheToast('è³‡æ–™å·²æ›´æ–°ï¼');
                        }
                    } else if (isBackgroundUpdate) {
                        console.log('èƒŒæ™¯æª¢æŸ¥ï¼šè³‡æ–™ç„¡è®Šæ›´');
                    }
                    
                } else if (!isBackgroundUpdate) {
                    app.containers.setupPrompt.classList.remove('hidden');
                    app.containers.setupPrompt.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ GAS ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚";
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                if (isBackgroundUpdate) {
                    showCacheToast('èƒŒæ™¯æ›´æ–°å¤±æ•—ï¼Œå°‡ä½¿ç”¨å¿«å–è³‡æ–™', true);
                } else {
                    app.containers.setupPrompt.classList.remove('hidden');
                    app.containers.setupPrompt.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ GAS ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚";
                }
            }
        };

        init();
    });
    </script>
</body>
</html>
